<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/gopl/ch11/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chapter 11. Testing - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../friendly.css" rel="stylesheet">
        <link href="../../theme.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../apue/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch7/">Chapter 7. Process Environment</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch8/">Chapter 8. Process Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch9/">Chapter 9. Process Relationships</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch10/">Chapter 10. Signals</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch11/">Chapter 11. Threads</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch12/">Chapter 12. Thread Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch16/">Chapter 16. Network IPC: Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch17/">Chapter 17. Advanced IPC</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../lkd/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch1/">Chapter 1. Introduction to the Linux Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch2/">Chapter 2. Getting Started with the Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch3/">Chapter 3. Process Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch4/">Chapter 4. Process Scheduling</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch5/">Chapter 5. System Calls</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch6/">Chapter 6. Kernel Data Structures</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch7/">Chapter 7. Interrupts and Interrupt Handlers</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch8/">Chapter 8. Bottom Halves and Deferring Work</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch9/">Chapter 9. An Introduction to Kernel Synchronization</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch10/">Chapter 10. Kernel Synchronization Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch11/">Chapter 11. Timers and Time Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch12/">Chapter 12. Memory Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch13/">Chapter 13. The Virtual Filesystem</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch14/">Chapter 14. The Block I/O Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch15/">Chapter 15. The Process Address Space</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch16/">Chapter 16. The Page Cache and Page Writeback</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../unp/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch7/">Chapter 7. Socket Options</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch8/">Chapter 8. Elementary UDP Sockets</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../tcpv1/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch3/">Chapter 3. Link Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch4/">Chapter 4. ARP: Address Resolution Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch6/">Chapter 6. System Configuration: DHCP and Autoconfiguration</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch7/">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch8/">Chapter 8. ICMPv4 and ICMPv6: Internet Control Message Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch9/">Chapter 9. Broadcasting and Local Multicasting (IGMP and MLD)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch11/">Chapter 11. Name Resolution and the Domain Name System (DNS)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch12/">Chapter 12. TCP: The Transmission Control Protocol (Preliminaries)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch13/">Chapter 13. TCP Connection Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch14/">Chapter 14. TCP Timeout and Retransmission</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch15/">Chapter 15. TCP Data Flow and Window Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch16/">Chapter 16. TCP Congestion Control</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch17/">Chapter 17. TCP Keepalive</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch18/">Chapter 18. Security: EAP, IPsec, TLS, DNSSEC, and DKIM</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GOPL <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../ch1/">Chapter 1. Tutorial</a>
                        </li>
                      
                        <li>
                            <a href="../ch2/">Chapter 2. Program Structure</a>
                        </li>
                      
                        <li>
                            <a href="../ch3/">Chapter 3. Basic Data Types</a>
                        </li>
                      
                        <li>
                            <a href="../ch4/">Chapter 4. Composite Types</a>
                        </li>
                      
                        <li>
                            <a href="../ch5/">Chapter 5. Functions</a>
                        </li>
                      
                        <li>
                            <a href="../ch6/">Chapter 6. Methods</a>
                        </li>
                      
                        <li>
                            <a href="../ch7/">Chapter 7. Interfaces</a>
                        </li>
                      
                        <li>
                            <a href="../ch8/">Chapter 8. Goroutines and Channels</a>
                        </li>
                      
                        <li>
                            <a href="../ch9/">Chapter 9. Concurrency with Shared Variables</a>
                        </li>
                      
                        <li>
                            <a href="../ch10/">Chapter 10. Packages and the Go Tool</a>
                        </li>
                      
                        <li class="active">
                            <a href="./">Chapter 11. Testing</a>
                        </li>
                      
                        <li>
                            <a href="../ch12/">Chapter 12. Reflection</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSN <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../csn/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part1/">Part 1: Language</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part2/">Part 2: Advanced</a>
                        </li>
                      
                    </ul>
                </li>
            <li>
                    <a href="../../toc/">TOC</a>
                </li>
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/gopl/ch11.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-11-testing">Chapter 11. Testing</a></li>
        
    
        <li class="main "><a href="#the-go-test-tool">The go test Tool</a></li>
        
    
        <li class="main "><a href="#test-functions">Test Functions</a></li>
        
            <li><a href="#randomized-testing">Randomized Testing</a></li>
        
            <li><a href="#testing-a-command">Testing a Command</a></li>
        
            <li><a href="#white-box-testing">White-Box Testing</a></li>
        
            <li><a href="#external-test-packages">External Test Packages</a></li>
        
            <li><a href="#writing-effective-tests">Writing Effective Tests</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chapter-11-testing"><strong>Chapter 11. Testing</strong><a class="headerlink" href="#chapter-11-testing" title="Permanent link">&para;</a></h3>
<p>[p301]</p>
<p>Programs today are far larger and more complex than in <a href="https://en.wikipedia.org/wiki/Maurice_Wilkes">Maurice Wilkes</a>'s time, and a great deal of effort has been spent on techniques to make this complexity manageable. Two techniques in particular stand out for their effectiveness:</p>
<ol>
<li>Routine peer review of programs before they are deployed.</li>
<li>Testing.</li>
</ol>
<p>Testing, by which we implicitly mean automated testing, is the practice of writing small programs that check that the code under test (the production code) behaves as expected for certain inputs, which are usually either carefully chosen to exercise certain features or randomized to ensure broad coverage.</p>
<p>[p301]</p>
<p>Go's approach to testing is rather low-tech in. It relies on one command, <code>go test</code>, and a set of conventions for writing test functions that <code>go test</code> can run. The comparatively lightweight mechanism is effective for pure testing, and it extends naturally to benchmarks and systematic examples for documentation.</p>
<p>In practice, writing test code is not much different from writing the original program itself.  We write short functions that focus on one part of the task. We have to be careful of boundary conditions, think about data structures, and reason about what results a computation should produce from suitable inputs. But this is the same process as writing ordinary Go code.</p>
<h3 id="the-go-test-tool">The <code>go test</code> Tool<a class="headerlink" href="#the-go-test-tool" title="Permanent link">&para;</a></h3>
<p>The <a href="https://golang.org/cmd/go/#hdr-Description_of_testing_flags"><code>go test</code></a> subcommand is a test driver for Go packages that are organized according to certain conventions. In a package directory, files whose names end with <code>_test.go</code> are not part of the package ordinarily built by <code>go build</code> but are a part of it when built by <code>go test</code>.</p>
<p>Within <code>*_test.go</code> files, three kinds of functions are treated specially: tests, benchmarks, and
examples.</p>
<ul>
<li>A <em>test function</em> is a function whose name begins with <code>Test</code>. It exercises some program logic for correct behavior; <code>go test</code> calls the test function and reports the result, which is either <code>PASS</code> or <code>FAIL</code>.</li>
<li>A <em>benchmark function</em> has a name beginning with <code>Benchmark</code> and measures the performance of some operation; <code>go test</code> reports the mean execution time of the operation.</li>
<li>A <em>example function</em>, whose name starts with <code>Example</code>, provides machine-checked documentation.</li>
</ul>
<p>The <code>go test</code> tool scans the <code>*_test.go</code> files for these special functions, generates a temporary <code>main</code> package that calls them all in the proper way, builds and runs it, reports the results, and then cleans up.</p>
<h3 id="test-functions">Test Functions<a class="headerlink" href="#test-functions" title="Permanent link">&para;</a></h3>
<p>Each test file must import the testing package. Test functions have the following signature:</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestName</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>


<p>Test function names must begin with <code>Test</code>; the optional suffix <code>Name</code> must begin with a capital letter:</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestSin</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">func</span> <span class="nx">TestCos</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">func</span> <span class="nx">TestLog</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</pre></div>


<p>The <code>t</code> parameter provides methods for reporting test failures and logging additional information.</p>
<p>For example, the package <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word.go">gopl.io/ch11/word1</a> contains a single function <code>IsPalindrome</code> that reports whether a string reads the same forward and backward.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word.go">gopl.io/ch11/word1/word.go</a></small></p>
<div class="codehilite"><pre><span class="c1">// Package word provides utilities for word games.</span>
<span class="kn">package</span> <span class="nx">word</span>

<span class="c1">// IsPalindrome reports whether s reads the same forward and backward.</span>
<span class="c1">// (Our first attempt.)</span>
<span class="kd">func</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>


<p>In the same directory, the file <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word1/word_test.go">word_test.go</a> contains two test functions named <code>TestPalindrome</code> and <code>TestNonPalindrome</code>. Each checks that <code>IsPalindrome</code> gives the right answer for a single input and reports failures using <code>t.Error</code>:</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">word</span>

<span class="kn">import</span> <span class="s">&quot;testing&quot;</span>

<span class="kd">func</span> <span class="nx">TestPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;detartrated&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;detartrated&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;kayak&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;kayak&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestNonPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;palindrome&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;palindrome&quot;) = true`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>A <code>go test</code> (or <code>go build</code>) command with no package arguments operates on the package in the current directory. We can build and run the tests with the following command.</p>
<div class="codehilite"><pre><span class="gp">$</span> <span class="nb">cd</span> $GOPATH/src/gopl.io/ch11/word1
<span class="gp">$</span> go <span class="nb">test</span>
<span class="go">ok</span>
<span class="go">gopl.io/ch11/word1 0.008s</span>
</pre></div>


<p>However, <code>IsPalindrome</code> cannot recognize some other palindrome strings such as "été" or "A man, a plan, a canal: Panama".</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestFrenchPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="s">&quot;été&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">`IsPalindrome(&quot;été&quot;) = false`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestCanalPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">input</span> <span class="o">:=</span> <span class="s">&quot;A man, a plan, a canal: Panama&quot;</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">`IsPalindrome(%q) = false`</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>To avoid writing the long input string twice, we use <code>Errorf</code>, which provides formatting like <code>Printf</code>.</p>
<p>When the two new tests have been added, the <code>go test</code> command fails with informative error messages.</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">FAIL</span>
</pre></div>


<p>As a bonus, running <code>go test</code> is usually quicker than manually going through the steps described in the bug report, allowing us to iterate more rapidly. If the test suite contains many slow tests, we may make even faster progress if we're selective about which ones we run.</p>
<p>The <code>-v</code> flag prints the name and execution time of each test in the package:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> -v
<span class="go">=== RUN TestPalindrome</span>
<span class="go">--- PASS: TestPalindrome (0.00s)</span>
<span class="go">=== RUN TestNonPalindrome</span>
<span class="go">--- PASS: TestNonPalindrome (0.00s)</span>
<span class="go">=== RUN TestFrenchPalindrome</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">=== RUN TestCanalPalindrome</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">exit status 1</span>
<span class="go">FAIL gopl.io/ch11/word1 0.017s</span>
</pre></div>


<p>The <code>-run</code> flag, whose argument is a regular expression, causes <code>go test</code> to run only those tests whose function name matches the pattern:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> -v -run<span class="o">=</span><span class="s2">&quot;French|Canal&quot;</span>
<span class="go">=== RUN TestFrenchPalindrome</span>
<span class="go">--- FAIL: TestFrenchPalindrome (0.00s)</span>
<span class="go">word_test.go:28: IsPalindrome(&quot;été&quot;) = false</span>
<span class="go">=== RUN TestCanalPalindrome</span>
<span class="go">--- FAIL: TestCanalPalindrome (0.00s)</span>
<span class="go">word_test.go:35: IsPalindrome(&quot;A man, a plan, a canal: Panama&quot;) = false</span>
<span class="go">FAIL</span>
<span class="go">exit status 1</span>
<span class="go">FAIL</span>
</pre></div>


<p>Once we've gotten the selected tests to pass, we should invoke <code>go test</code> with no flags to run the entire test suite one last time before we commit the change.</p>
<p>A quick investigation reveals the cause of the first bug to be <code>IsPalindrome</code>'s use of byte sequences, not rune sequences, so that non-ASCII characters such as the é in "<code>été</code>" confuse it. The second bug arises from not ignoring spaces, punctuation, and letter case.</p>
<p>Then we rewrite the function more carefully:</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/word2/word.go">gopl.io/ch11/word2/word.go</a></small></p>
<div class="codehilite"><pre><span class="go">// Package word provides utilities for word games.</span>
<span class="go">package word</span>

<span class="go">import &quot;unicode&quot;</span>

<span class="go">// IsPalindrome reports whether s reads the same forward and backward.</span>
<span class="go">// Letter case is ignored, as are non-letters.</span>
<span class="go">func IsPalindrome(s string) bool {</span>
<span class="go">    var letters []rune</span>
<span class="go">    for _, r := range s {</span>
<span class="go">        if unicode.IsLetter(r) {</span>
<span class="go">            letters = append(letters, unicode.ToLower(r))</span>
<span class="go">        }</span>
<span class="go">    }</span>
<span class="go">    for i := range letters {</span>
<span class="go">        if letters[i] != letters[len(letters)-1-i] {</span>
<span class="go">            return false</span>
<span class="go">        }</span>
<span class="go">    }</span>
<span class="go">    return true</span>
<span class="go">}</span>
</pre></div>


<p>We also write a more comprehensive set of test cases that combines all the previous ones and a number of new ones into a table.</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestIsPalindrome</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tests</span> <span class="p">=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">input</span> <span class="kt">string</span>
        <span class="nx">want</span>  <span class="kt">bool</span>
    <span class="p">}{</span>
        <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;aa&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;ab&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;kayak&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;detartrated&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;A man, a plan, a canal: Panama&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Evil I did dwell; lewd did I live.&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Able was I ere I saw Elba&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;été&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;Et se resservir, ivresse reste.&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;palindrome&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="c1">// non-palindrome</span>
        <span class="p">{</span><span class="s">&quot;desserts&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span>   <span class="c1">// semi-palindrome</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">test</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tests</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">got</span> <span class="o">:=</span> <span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;IsPalindrome(%q) = %v&quot;</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">got</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The new tests pass:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> gopl.io/ch11/word2
<span class="go">ok gopl.io/ch11/word2 0.015s</span>
</pre></div>


<p>This style of <a href="https://en.wikipedia.org/wiki/Keyword-driven_testing">table-driven testing</a> (see also <a href="https://github.com/golang/go/wiki/TableDrivenTests">TableDrivenTests</a>) is very common in Go. It is straightforward to add new table entries as needed.</p>
<p>The output of a failing test does not include the entire stack trace at the moment of the call to <code>t.Errorf</code>. Nor does <code>t.Errorf</code> cause a panic or stop the execution of the test, unlike assertion failures in many test frameworks for other languages. Tests are independent of each other. If an early entry in the table causes the test to fail, later table entries will still be checked, and thus we may learn about multiple failures during a single run.</p>
<p>When we really must stop a test function, perhaps because some initialization code failed or to prevent a failure already reported from causing a confusing cascade of others, we use <code>t.Fatal</code> or <code>t.Fatalf</code>. <u>These must be called from the same goroutine as the <code>Test</code> function, not from another one created during the test.</u></p>
<p>Test failure messages are usually of the form "<code>f(x) = y, want z</code>", where <code>f(x)</code> explains the attempted operation and its input, <code>y</code> is the actual result, and <code>z</code> the expected result:</p>
<ul>
<li>Where convenient, actual Go syntax is used for the <code>f(x)</code> part.</li>
<li>Displaying <code>x</code> is particularly important in a table-driven test, since a given assertion is executed many times with different values.</li>
<li>Avoid boilerplate and redundant information. When testing a boolean function such as <code>IsPalindrome</code>, omit the <code>want z</code> part since it adds no information. If <code>x</code>, <code>y</code>, or <code>z</code> is lengthy, print a concise summary of the relevant parts instead.</li>
<li>The author of a test should strive to help the programmer who must diagnose a test failure.</li>
</ul>
<h4 id="randomized-testing">Randomized Testing<a class="headerlink" href="#randomized-testing" title="Permanent link">&para;</a></h4>
<p>Table-driven tests are convenient for checking that a function works on inputs which are carefully selected to exercise interesting cases in the logic. Another approach, <a href="https://en.wikipedia.org/wiki/Random_testing"><em>randomized testing</em></a>, explores a broader range of inputs by constructing inputs at random.</p>
<p>How do we know what output to expect from our function, given a random input? There are two strategies:</p>
<ol>
<li>Write an alternative implementation of the function that uses a less efficient but simpler and clearer algorithm, and check that both implementations give the same result.</li>
<li>Create input values according to a pattern so that we know what output to expect.</li>
</ol>
<p>The example below uses the second approach: the <code>randomPalindrome</code> function generates words that are known to be palindromes by construction.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="s">&quot;math/rand&quot;</span>

<span class="c1">// randomPalindrome returns a palindrome whose length and contents</span>
<span class="c1">// are derived from the pseudo-random number generator rng.</span>
<span class="kd">func</span> <span class="nx">randomPalindrome</span><span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Rand</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="c1">// random length up to 24</span>
    <span class="nx">runes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">rune</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">:=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">rng</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">))</span> <span class="c1">// random rune up to &#39;\u0999&#39;</span>
      <span class="nx">runes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">r</span>
      <span class="nx">runes</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">r</span>
  <span class="p">}</span>
    <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">runes</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestRandomPalindromes</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize a pseudo-random number generator.</span>
    <span class="nx">seed</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UTC</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;Random seed: %d&quot;</span><span class="p">,</span> <span class="nx">seed</span><span class="p">)</span>
    <span class="nx">rng</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">NewSource</span><span class="p">(</span><span class="nx">seed</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="nx">p</span> <span class="o">:=</span> <span class="nx">randomPalindrome</span><span class="p">(</span><span class="nx">rng</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">IsPalindrome</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;IsPalindrome(%q) = false&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Since randomized tests are nondeterministic, it is critical the failing test logs sufficient information to reproduce the failure. In the above example, the input <code>p</code> to <code>IsPalindrome</code> is all we need to know, but for functions that accept more complex inputs, it may be simpler to log the seed of the pseudo-random number generator (as we do above) than to dump the entire input data structure. With that seed value, we can easily modify the test to replay the failure deterministically.</p>
<p>By using the current time as a source of randomness, the test will explore novel inputs each time it is run, over the entire course of its lifetime. This is especially valuable if your project uses an automated system to run all its tests periodically.</p>
<h4 id="testing-a-command">Testing a Command<a class="headerlink" href="#testing-a-command" title="Permanent link">&para;</a></h4>
<p>The <code>go test</code> tool is useful for testing library packages. We can use it to test commands as well. A package named <code>main</code> ordinarily produces an executable program, but it can also be imported as a library.</p>
<p>Consider the <a href="https://github.com/shichao-an/gopl.io/blob/master/ch2/echo4/main.go"><code>echo</code></a> program of <a href="../ch2/#pointers">Section 2.3.2</a>. The program is split into two functions: <code>echo</code> does the real work, while <code>main</code> parses and reads the flag values and reports any errors returned by <code>echo</code>.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/echo/echo.go">gopl.io/ch11/echo/echo.go</a></small></p>
<div class="codehilite"><pre><span class="c1">// Echo prints its command-line arguments.</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;flag&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;io&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">n</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;omit trailing newline&quot;</span><span class="p">)</span>
    <span class="nx">s</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;separator&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">out</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span> <span class="c1">// modified during testing</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">echo</span><span class="p">(!</span><span class="o">*</span><span class="nx">n</span><span class="p">,</span> <span class="o">*</span><span class="nx">s</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Args</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&quot;echo: %v\n&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">echo</span><span class="p">(</span><span class="nx">newline</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">sep</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprint</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">sep</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">newline</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<p>We will write a test:</p>
<ul>
<li>It calls <code>echo</code> with a variety of arguments and flag settings and check that it prints the correct output in each case, so we've added parameters to <code>echo</code> to reduce its dependence on global variables.</li>
<li>We've also introduced another global variable, <code>out</code>, the <code>io.Writer</code> to which the result will be written. By having <code>echo</code> write through this variable, not directly to <code>os.Stdout</code>, the tests can substitute a different <code>Writer</code> implementation that records what was written for later inspection.</li>
</ul>
<p>The test is in file <a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/echo/echo_test.go">echo_test.go</a>:</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;bytes&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;testing&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">TestEcho</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tests</span> <span class="p">=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">newline</span> <span class="kt">bool</span>
        <span class="nx">sep</span>     <span class="kt">string</span>
        <span class="nx">args</span>    <span class="p">[]</span><span class="kt">string</span>
        <span class="nx">want</span>    <span class="kt">string</span>
    <span class="p">}{</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span> <span class="s">&quot;\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;\t&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">},</span> <span class="s">&quot;one\ttwo\tthree\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">},</span> <span class="s">&quot;a,b,c\n&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;3&quot;</span><span class="p">},</span> <span class="s">&quot;1:2:3&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">test</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tests</span> <span class="p">{</span>
        <span class="nx">descr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;echo(%v, %q, %q)&quot;</span><span class="p">,</span>
            <span class="nx">test</span><span class="p">.</span><span class="nx">newline</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">sep</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span>

        <span class="nx">out</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span> <span class="c1">// captured output</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">echo</span><span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">newline</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">sep</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;%s failed: %v&quot;</span><span class="p">,</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="nx">got</span> <span class="o">:=</span> <span class="nx">out</span><span class="p">.(</span><span class="o">*</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">).</span><span class="nx">String</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;%s = %q, want %q&quot;</span><span class="p">,</span> <span class="nx">descr</span><span class="p">,</span> <span class="nx">got</span><span class="p">,</span> <span class="nx">test</span><span class="p">.</span><span class="nx">want</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Notice that the test code is in the same package as the production code. <u>Although the package name is <code>main</code> and it defines a <code>main</code> function, during testing this package acts as a library that exposes the function <code>TestEcho</code> to the test driver; its <code>main</code> function is ignored. By organizing the test as a table, we can easily add new test cases.</u> Let's see what happens when the test fails, by adding this line to the table:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">},</span> <span class="s">&quot;a b c\n&quot;</span><span class="p">},</span> <span class="c1">// NOTE: wrong expectation!</span>
</pre></div>


<p><code>go test</code> prints:</p>
<div class="codehilite"><pre><span class="gp">$</span> go <span class="nb">test</span> gopl.io/ch11/echo
<span class="go">--- FAIL: TestEcho (0.00s)</span>
<span class="go">echo_test.go:31: echo(true, &quot;,&quot;, [&quot;a&quot; &quot;b&quot; &quot;c&quot;]) = &quot;a,b,c&quot;, want &quot;a b c\n&quot;</span>
<span class="go">FAIL</span>
<span class="go">FAIL gopl.io/ch11/echo 0.006s</span>
</pre></div>


<p>The error message describes the attempted operation (using Go-like syntax), the actual behavior, and the expected behavior, in that order. With an informative error message such as this, you may have a pretty good idea about the root cause before you've even located the source code of the test.</p>
<p>It's important that code being tested not call <code>log.Fatal</code> or <code>os.Exit</code>, since these will stop the process in its tracks; calling these functions should be regarded as the exclusive right of <code>main</code>. If something totally unexpected happens and a function panics, the test driver will recover, though the test will be considered a failure. Expected errors such as those resulting from bad user input, missing files, or improper configuration should be reported by returning a non-nil error value. However, our echo example is so simple that it will never return a non-nil error.</p>
<h4 id="white-box-testing">White-Box Testing<a class="headerlink" href="#white-box-testing" title="Permanent link">&para;</a></h4>
<p>We can categorize tests by the level of knowledge required for the internal workings of the package under test:</p>
<ul>
<li>A <a href="https://en.wikipedia.org/wiki/Black-box_testing"><em>black-box test</em></a> assumes nothing about the package other than
what is exposed by its API and specified by its documentation. The package's internals are opaque.</li>
<li>In contrast, a <a href="https://en.wikipedia.org/wiki/White-box_testing"><em>white-box test</em></a> (or <em>clear box test</em>) has privileged access to the internal functions and data structures of the package and can make observations and changes that an ordinary client cannot. For example, a white-box test can check that the invariants of the package's data types are maintained after every operation.</li>
</ul>
<p>The two approaches are complementary:</p>
<ul>
<li>Black-box tests are usually more robust, needing fewer updates as the software evolves. They also help the author empathize with the client of the package and can reveal flaws in the API design.</li>
<li>In contrast, white-box tests can provide more detailed coverage of the trickier parts of the implementation.</li>
</ul>
<p>In the previous examples:</p>
<ul>
<li><code>TestIsPalindrome</code> calls only the exported function <code>IsPalindrome</code> and is thus a black-box test.</li>
<li><code>TestEcho</code> calls the <code>echo</code> function and updates the global variable <code>out</code>, both of which are unexported, making it a white-box test.</li>
</ul>
<p>While developing <code>TestEcho</code>, we modified the <code>echo</code> function to use the package-level variable <code>out</code> when writing its output, so that the test could replace the standard output with an alternative implementation that records the data for later inspection. Using the same technique, we can replace other parts of the production code with easy-to-test "fake" implementations. The advantage of fake implementations is that they can be simpler to configure, more predictable, more reliable, and easier to observe. They can also avoid undesirable side effects such as updating a production database or charging a credit card.</p>
<p>The code below shows the quota-checking logic in a web service that provides networked storage to users. When users exceed 90% of their quota, the system sends them a warning email.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/storage1/storage.go">gopl.io/ch11/storage1/storage.go</a></small></p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">storage</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;log&quot;</span>
    <span class="s">&quot;net/smtp&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">bytesInUse</span><span class="p">(</span><span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span> <span class="cm">/* ... */</span> <span class="p">}</span>

<span class="c1">// Email sender configuration.</span>
<span class="c1">// NOTE: never put passwords in source code!</span>
<span class="kd">const</span> <span class="nx">sender</span> <span class="p">=</span> <span class="s">&quot;notifications@example.com&quot;</span>
<span class="kd">const</span> <span class="nx">password</span> <span class="p">=</span> <span class="s">&quot;correcthorsebatterystaple&quot;</span>
<span class="kd">const</span> <span class="nx">hostname</span> <span class="p">=</span> <span class="s">&quot;smtp.example.com&quot;</span>

<span class="kd">const</span> <span class="nx">template</span> <span class="p">=</span> <span class="s">`Warning: you are using %d bytes of storage,</span>
<span class="s">%d%% of your quota.`</span>

<span class="kd">func</span> <span class="nx">CheckQuota</span><span class="p">(</span><span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">used</span> <span class="o">:=</span> <span class="nx">bytesInUse</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">quota</span> <span class="p">=</span> <span class="mi">1000000000</span> <span class="c1">// 1GB</span>
    <span class="nx">percent</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nx">used</span> <span class="o">/</span> <span class="nx">quota</span>
    <span class="k">if</span> <span class="nx">percent</span> <span class="p">&lt;</span> <span class="mi">90</span> <span class="p">{</span>
        <span class="k">return</span> <span class="c1">// OK</span>
    <span class="p">}</span>
    <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">used</span><span class="p">,</span> <span class="nx">percent</span><span class="p">)</span>
    <span class="nx">auth</span> <span class="o">:=</span> <span class="nx">smtp</span><span class="p">.</span><span class="nx">PlainAuth</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">smtp</span><span class="p">.</span><span class="nx">SendMail</span><span class="p">(</span><span class="nx">hostname</span><span class="o">+</span><span class="s">&quot;:587&quot;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">username</span><span class="p">},</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;smtp.SendMail(%s) failed: %s&quot;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>However, we don't want the test to send out real email. We can move the email logic into its own function and store that function in an unexported package-level variable, <code>notifyUser</code>.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/storage2/storage.go">gopl.io/ch11/storage2/storage.go</a></small></p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">notifyUser</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">auth</span> <span class="o">:=</span> <span class="nx">smtp</span><span class="p">.</span><span class="nx">PlainAuth</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">smtp</span><span class="p">.</span><span class="nx">SendMail</span><span class="p">(</span><span class="nx">hostname</span><span class="o">+</span><span class="s">&quot;:587&quot;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span>
        <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">username</span><span class="p">},</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;smtp.SendEmail(%s) failed: %s&quot;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">CheckQuota</span><span class="p">(</span><span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">used</span> <span class="o">:=</span> <span class="nx">bytesInUse</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">quota</span> <span class="p">=</span> <span class="mi">1000000000</span> <span class="c1">// 1GB</span>
    <span class="nx">percent</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nx">used</span> <span class="o">/</span> <span class="nx">quota</span>
    <span class="k">if</span> <span class="nx">percent</span> <span class="p">&lt;</span> <span class="mi">90</span> <span class="p">{</span>
        <span class="k">return</span> <span class="c1">// OK</span>
    <span class="p">}</span>
    <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">used</span><span class="p">,</span> <span class="nx">percent</span><span class="p">)</span>
    <span class="nx">notifyUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>We can now write a test that substitutes a simple fake notification mechanism instead of sending real email. This one records the notified user and the contents of the message.</p>
<p><small><a href="https://github.com/shichao-an/gopl.io/blob/master/ch11/storage2/quota_test.go">gopl.io/ch11/storage2/quota_test.go</a></small></p>
<div class="codehilite"><pre><span class="c1">//!+test</span>
<span class="kn">package</span> <span class="nx">storage</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;strings&quot;</span>
    <span class="s">&quot;testing&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">TestCheckQuotaNotifiesUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">notifiedUser</span><span class="p">,</span> <span class="nx">notifiedMsg</span> <span class="kt">string</span>
    <span class="nx">notifyUser</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">notifiedUser</span><span class="p">,</span> <span class="nx">notifiedMsg</span> <span class="p">=</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">user</span> <span class="p">=</span> <span class="s">&quot;joe@example.org&quot;</span>

    <span class="c1">// Simulate a 980MB-used condition for this user.</span>
    <span class="c1">// NOTE: this differs slightly from the printed version.</span>
    <span class="nx">usage</span><span class="p">[</span><span class="s">&quot;joe@example.org&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">980000000</span>

    <span class="nx">CheckQuota</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">notifiedUser</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">notifiedMsg</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;notifyUser not called&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">notifiedUser</span> <span class="o">!=</span> <span class="nx">user</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;wrong user (%s) notified, want %s&quot;</span><span class="p">,</span>
            <span class="nx">notifiedUser</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">wantSubstring</span> <span class="p">=</span> <span class="s">&quot;98% of your quota&quot;</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">notifiedMsg</span><span class="p">,</span> <span class="nx">wantSubstring</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;unexpected notification message &lt;&lt;%s&gt;&gt;, &quot;</span><span class="o">+</span>
            <span class="s">&quot;want substring %q&quot;</span><span class="p">,</span> <span class="nx">notifiedMsg</span><span class="p">,</span> <span class="nx">wantSubstring</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>There's one problem: after this test function has returned, <code>CheckQuota</code> no longer works as it should because it's still using the test's fake implementation of <code>notifyUsers</code>. (There is always a risk of this kind when updating global variables.) We must modify the test to restore the previous value so that subsequent tests observe no effect, and we must do this on all execution paths, including test failures and panics. This naturally suggests <code>defer</code>.</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestCheckQuotaNotifiesUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Save and restore original notifyUser.</span>
    <span class="nx">saved</span> <span class="o">:=</span> <span class="nx">notifyUser</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">notifyUser</span> <span class="p">=</span> <span class="nx">saved</span> <span class="p">}()</span>
    <span class="c1">// Install the test&#39;s fake notifyUser.</span>
    <span class="kd">var</span> <span class="nx">notifiedUser</span><span class="p">,</span> <span class="nx">notifiedMsg</span> <span class="kt">string</span>
    <span class="nx">notifyUser</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">notifiedUser</span><span class="p">,</span> <span class="nx">notifiedMsg</span> <span class="p">=</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">msg</span>
    <span class="p">}</span>
    <span class="c1">// ...rest of test...</span>
<span class="p">}</span>
</pre></div>


<p>This pattern can be used to do the following:</p>
<ul>
<li>Temporarily save and restore all kinds of global variables, including command-line flags, debugging options, and performance parameters</li>
<li>Install and remove hooks that cause the production code to call some test code when something interesting happens</li>
<li>Coax the production code into rare but important states, such as timeouts, errors, and even specific interleavings of concurrent activities.</li>
</ul>
<p>Using global variables in this way is safe only because <code>go test</code> does not normally run multiple tests concurrently.</p>
<h4 id="external-test-packages">External Test Packages<a class="headerlink" href="#external-test-packages" title="Permanent link">&para;</a></h4>
<p>Consider the following packages:</p>
<ul>
<li><a href="https://golang.org/pkg/net/url/"><code>net/url</code></a>, which provides a URL parser</li>
<li><a href="https://golang.org/pkg/net/http/"><code>net/http</code></a>, which provides a web server and HTTP client library.</li>
</ul>
<p>The higher-level <code>net/http</code> depends on the lower-level <code>net/url</code>. However, one of the tests in <code>net/url</code> is an example demonstrating the interaction between URLs and the HTTP client library. In other words, a test of the lower-level package imports the higher-level package.</p>
<p><a href="../figure_11.1.png" title="Figure 11.1. A test of net/url depends on net/http."><img alt="Figure 11.1. A test of net/url depends on net/http." src="../figure_11.1.png" /></a></p>
<p>Declaring this test function in the <code>net/url</code> package would create a cycle in the package import graph, as depicted by the upwards arrow in figure above, but as we explained in <a href="../ch10/#introduction">Section 10.1</a>, the Go specification forbids import cycles.</p>
<p>We resolve the problem by declaring the test function in an external test package, that is, in a file in the <code>net/url</code> directory whose package declaration reads package <code>url_test</code>. The extra suffix <code>_test</code> is a signal to <code>go test</code> that it should build an additional package containing just these files and run its tests. It may be helpful to think of this external test package as if it had the import path <code>net/url_test</code>, but it cannot be imported under this or any other name. See <a href="../ch10/#the-last-segment-convention">The Last Segment Convention</a> in Chapter 10 for details.</p>
<p>Because external tests live in a separate package, they may import helper packages that also depend on the package being tested; an in-package test cannot do this. In terms of the design layers, the external test package is logically higher up than both of the packages it depends upon, as shown in the figure below.</p>
<p><a href="../figure_11.2.png" title="Figure 11.2. External test packages break dependency cycles."><img alt="Figure 11.2. External test packages break dependency cycles." src="../figure_11.2.png" /></a></p>
<p>By avoiding import cycles, external test packages allow tests, especially <a href="https://en.wikipedia.org/wiki/Integration_testing"><em>integration tests</em></a> (which test the interaction of several components), to import other packages freely, exactly as an application would.</p>
<p>We can use the <code>go list</code> tool to summarize Go source files in a package directory to determine if they are one of the following:
<em> production code
</em> in-package tests
* external tests.</p>
<p>Use the <code>fmt</code> package as an example:</p>
<p><code>GoFiles</code> is the list of files that contain the production code; these are the files that <code>go build</code> will include in your application:</p>
<div class="codehilite"><pre><span class="gp">$</span> go list -f<span class="o">={{</span>.GoFiles<span class="o">}}</span> fmt
<span class="go">[doc.go format.go print.go scan.go]</span>
</pre></div>


<p><code>TestGoFiles</code> is the list of files that also belong to the <code>fmt</code> package, but these files, whose names all end in <code>_test.go</code>, are included only when building tests:</p>
<div class="codehilite"><pre><span class="gp">$</span> go list -f<span class="o">={{</span>.TestGoFiles<span class="o">}}</span> fmt
<span class="go">[export_test.go]</span>
</pre></div>


<p>The package's tests would usually reside in these files, though unusually <code>fmt</code> has none. The purpose of <code>export_test.go</code> in a moment.</p>
<p><code>XTestGoFiles</code> is the list of files that constitute the external test package, <code>fmt_test</code>, so these files must import the fmt package in order to use it; again, they are included only during testing:</p>
<div class="codehilite"><pre><span class="err">$</span> <span class="k">go</span> <span class="nx">list</span> <span class="o">-</span><span class="nx">f</span><span class="p">={{.</span><span class="nx">XTestGoFiles</span><span class="p">}}</span> <span class="nx">fmt</span>
<span class="p">[</span><span class="nx">fmt_test</span><span class="p">.</span><span class="k">go</span> <span class="nx">scan_test</span><span class="p">.</span><span class="k">go</span> <span class="nx">stringer_test</span><span class="p">.</span><span class="k">go</span><span class="p">]</span>
</pre></div>


<p>Sometimes an external test package may need privileged access to the internals of the package under test. For example, a white-box test must live in a separate package to avoid an import cycle. In such cases, we use a trick: we add declarations to an in-package <code>_test.go</code> file to expose the necessary internals to the external test. This file thus offers the test a "back door" to the package. If the source file exists only for this purpose and contains no tests itself, it is often called <code>export_test.go</code>.</p>
<p>For example, the implementation of the <code>fmt</code> package needs the functionality of <a href="https://golang.org/pkg/unicode/#IsSpace"><code>unicode.IsSpace</code></a> as part of <a href="https://golang.org/pkg/fmt/#Scanf"><code>fmt.Scanf</code></a>. To avoid creating an undesirable dependency, <code>fmt</code> does not import the <code>unicode</code> package and its large tables of data; instead, it contains a simpler implementation, which it calls <code>isSpace</code>.</p>
<p>To ensure that the behaviors of <code>fmt.isSpace</code> and <code>unicode.IsSpace</code> do not drift apart, <code>fmt</code> prudently contains a test. It is an external test, and thus it cannot access <code>isSpace</code> directly, so <code>fmt</code> opens a back door to it by declaring an exported variable that holds the internal <code>isSpace</code> function. This is the entirety of the <code>fmt</code> package's <code>export_test.go</code> file.</p>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nx">fmt</span>

<span class="kd">var</span> <span class="nx">IsSpace</span> <span class="p">=</span> <span class="nx">isSpace</span>
</pre></div>


<p>This test file defines no tests; it declares the exported symbol <code>fmt.IsSpace</code> for use by the external test. This trick can also be used whenever an external test needs to use some of the techniques of white-box testing.</p>
<h4 id="writing-effective-tests">Writing Effective Tests<a class="headerlink" href="#writing-effective-tests" title="Permanent link">&para;</a></h4>
<p>Many newcomers to Go are surprised by the minimalism of its testing framework. Testing frameworks in other languages may provide:</p>
<ul>
<li>Mechanisms for identifying test functions (often using reflection or metadata)</li>
<li>Hooks for performing "setup" and "teardown" operations before and after the tests run</li>
<li>Libraries of utility functions for asserting common predicates, comparing values, formatting error messages, and aborting a failed test (often using exceptions)</li>
</ul>
<p>Although these mechanisms can make tests very concise, the resulting tests often seem like they are written in a foreign language. Furthermore, although they may report <code>PASS</code> or <code>FAIL</code> correctly, their manner may be unfriendly to the unfortunate maintainer, with cryptic failure messages like "<code>assert: 0 == 1</code>" or page after page of stack traces.</p>
<p>However, Go expects test authors to do most of this work themselves, defining functions to avoid repetition, just as they would for ordinary programs. The process of testing is not one of rote form filling; a test has a "user interface" too, albeit one whose only users are also its maintainers.</p>
<p>What is a good test?</p>
<ul>
<li>A good test does not explode on failure but prints a clear and succinct description of the symptom of the problem, and perhaps other relevant facts about the context. The maintainer should not need to read the source code to decipher a test failure.</li>
<li>A good test should not give up after one failure but should try to report several errors in a single run, since the pattern of failures may itself be revealing.</li>
</ul>
<p>The assertion function below compares two values, constructs a generic error message, and stops the program. It's easy to use and it's correct, but when it fails, the error message is almost useless. It does not provide a good user interface.</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;strings&quot;</span>
    <span class="s">&quot;testing&quot;</span>
<span class="p">)</span>

<span class="c1">// A poor assertion function.</span>
<span class="kd">func</span> <span class="nx">assertEqual</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="nx">y</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%d != %d&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestSplit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">words</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="s">&quot;a:b:c&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>
    <span class="nx">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">words</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>


<p>Assertion functions suffer from <em>premature abstraction</em>. It treats the failure of this particular test as a mere difference of two integers, so we forfeit the opportunity to provide meaningful context. We can provide a better message by starting from the concrete details, as in the example below.</p>
<div class="codehilite"><pre><span class="kd">func</span> <span class="nx">TestSplit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">,</span> <span class="nx">sep</span> <span class="o">:=</span> <span class="s">&quot;a:b:c&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span>
    <span class="nx">words</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">sep</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">got</span><span class="p">,</span> <span class="nx">want</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">words</span><span class="p">),</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">got</span> <span class="o">!=</span> <span class="nx">want</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Split(%q, %q) returned %d words, want %d&quot;</span><span class="p">,</span>
            <span class="nx">s</span><span class="p">,</span> <span class="nx">sep</span><span class="p">,</span> <span class="nx">got</span><span class="p">,</span> <span class="nx">want</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>


<p>In this test:</p>
<ul>
<li>It reports the function that was called, its inputs, and the significance of the result;</li>
<li>It explicitly identifies the actual value and the expectation;</li>
<li>It continues to execute even if this assertion should fail.</li>
</ul>
<p>Once we've written a test like this, the natural next step is often not to define a function to replace the entire if statement, but to execute the test in a loop in which <code>s</code>, <code>sep</code>, and <code>want</code> vary, like the table-driven test of <code>IsPalindrome</code>.</p>
<p>The previous example didn't need any utility functions, but that shouldn't stop us from introducing functions when they help make the code simpler. (We'll look at one such utility function, <code>reflect.DeepEqual</code>, in <a href="ch13.md#example-deep-equivalence">Section 13.3</a>.) The key to a good test is to start by implementing the concrete behavior that you want and only then use functions to simplify the code and eliminate repetition. Best results are rarely obtained by starting with a library of abstract, generic testing functions.</p>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>