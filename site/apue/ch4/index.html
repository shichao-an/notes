<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/apue/ch4/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chapter 4. Files and Directories - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../friendly.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                      
                        <li>
                            <a href="../ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                      
                        <li>
                            <a href="../ch3/">Chapter 3. File I/O</a>
                        </li>
                      
                        <li class="active">
                            <a href="./">Chapter 4. Files and Directories</a>
                        </li>
                      
                        <li>
                            <a href="../ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                      
                        <li>
                            <a href="../ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                      
                        <li>
                            <a href="../ch7/">Chapter 7. Process Environment</a>
                        </li>
                      
                        <li>
                            <a href="../ch8/">Chapter 8. Process Control</a>
                        </li>
                      
                        <li>
                            <a href="../ch9/">Chapter 9. Process Relationships</a>
                        </li>
                      
                        <li>
                            <a href="../ch10/">Chapter 10. Signals</a>
                        </li>
                      
                        <li>
                            <a href="../ch11/">Chapter 11. Threads</a>
                        </li>
                      
                        <li>
                            <a href="../ch12/">Chapter 12. Thread Control</a>
                        </li>
                      
                        <li>
                            <a href="../ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                      
                        <li>
                            <a href="../ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                      
                        <li>
                            <a href="../ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                      
                        <li>
                            <a href="../ch16/">Chapter 16. Network IPC: Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../ch17/">Chapter 17. Advanced IPC</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../lkd/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch1/">Chapter 1. Introduction to the Linux Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch2/">Chapter 2. Getting Started with the Kernel</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch3/">Chapter 3. Process Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch4/">Chapter 4. Process Scheduling</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch5/">Chapter 5. System Calls</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch6/">Chapter 6. Kernel Data Structures</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch7/">Chapter 7. Interrupts and Interrupt Handlers</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch8/">Chapter 8. Bottom Halves and Deferring Work</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch9/">Chapter 9. An Introduction to Kernel Synchronization</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch10/">Chapter 10. Kernel Synchronization Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch11/">Chapter 11. Timers and Time Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch12/">Chapter 12. Memory Management</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch13/">Chapter 13. The Virtual Filesystem</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch14/">Chapter 14. The Block I/O Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch15/">Chapter 15. The Process Address Space</a>
                        </li>
                      
                        <li>
                            <a href="../../lkd/ch16/">Chapter 16. The Page Cache and Page Writeback</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../unp/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch7/">Chapter 7. Socket Options</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch8/">Chapter 8. Elementary UDP Sockets</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../tcpv1/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch3/">Chapter 3. Link Layer</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch4/">Chapter 4. ARP: Address Resolution Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch6/">Chapter 6. System Configuration: DHCP and Autoconfiguration</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch7/">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch8/">Chapter 8. ICMPv4 and ICMPv6: Internet Control Message Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch9/">Chapter 9. Broadcasting and Local Multicasting (IGMP and MLD)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch11/">Chapter 11. Name Resolution and the Domain Name System (DNS)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch12/">Chapter 12. TCP: The Transmission Control Protocol (Preliminaries)</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch13/">Chapter 13. TCP Connection Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch14/">Chapter 14. TCP Timeout and Retransmission</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch15/">Chapter 15. TCP Data Flow and Window Management</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch16/">Chapter 16. TCP Congestion Control</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch17/">Chapter 17. TCP Keepalive</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/ch18/">Chapter 18. Security: EAP, IPsec, TLS, DNSSEC, and DKIM</a>
                        </li>
                      
                        <li>
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GOPL <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../gopl/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch1/">Chapter 1. Tutorial</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch2/">Chapter 2. Program Structure</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch3/">Chapter 3. Basic Data Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch4/">Chapter 4. Composite Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch5/">Chapter 5. Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch6/">Chapter 6. Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch7/">Chapter 7. Interfaces</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch10/">Chapter 10. Packages and the Go Tool</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">PER <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../per/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../per/ch1/">Chapter 1. A Tutorial Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../per/ch6/">Chapter 6. Functions and Functional Programming</a>
                        </li>
                      
                        <li>
                            <a href="../../per/ch7/">Chapter 7. Classes and Object-Oriented Programming</a>
                        </li>
                      
                        <li>
                            <a href="../../per/ch15/">Chapter 15. Data Structures, Algorithms, and Code Simplification</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TWGR <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../twgr/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../twgr/ch1/">Chapter 1. Bootstrapping your Ruby literacy</a>
                        </li>
                      
                        <li>
                            <a href="../../twgr/ch2/">Chapter 2. Objects, methods, and local variables</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">SPEC <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../spec/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch2/">Chapter 2. Methodology</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch3/">Chapter 3. Operating Systems</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch4/">Chapter 4. Observability Tools</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch5/">Chapter 5. Applications</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch6/">Chapter 6. CPUs</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch7/">Chapter 7. Memory</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch8/">Chapter 8. File Systems</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch9/">Chapter 9. Disks</a>
                        </li>
                      
                        <li>
                            <a href="../../spec/ch10/">Chapter 10. Network</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">BD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../bd/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../bd/ch1/">Chapter 1. A new paradigm for Big Data</a>
                        </li>
                      
                        <li>
                            <a href="../../bd/ch2/">Chapter 2. Data model for Big Data</a>
                        </li>
                      
                        <li>
                            <a href="../../bd/ch3/">Chapter 3. Data model for Big Data: Illustration</a>
                        </li>
                      
                    </ul>
                </li>
            
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/apue/ch4.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-4-files-and-directories">Chapter 4. Files and Directories</a></li>
        
    
        <li class="main "><a href="#restrict-keyword">restrict keyword</a></li>
        
    
        <li class="main "><a href="#stat-fstat-fstatat-and-lstat-functions">stat, fstat, fstatat, and lstat Functions</a></li>
        
            <li><a href="#timespec-structure">timespec structure</a></li>
        
    
        <li class="main "><a href="#file-types">File Types</a></li>
        
    
        <li class="main "><a href="#set-user-id-and-set-group-id">Set-User-ID and Set-Group-ID</a></li>
        
    
        <li class="main "><a href="#file-access-permissions">File Access Permissions</a></li>
        
    
        <li class="main "><a href="#ownership-of-new-files-and-directories">Ownership of New Files and Directories</a></li>
        
    
        <li class="main "><a href="#access-and-faccessat-functions">access and faccessat Functions</a></li>
        
    
        <li class="main "><a href="#umask-function">umask Function</a></li>
        
    
        <li class="main "><a href="#chmod-fchmod-and-fchmodat-functions">chmod, fchmod, and fchmodat Functions</a></li>
        
    
        <li class="main "><a href="#sticky-bit">Sticky Bit</a></li>
        
    
        <li class="main "><a href="#chown-fchown-fchownat-and-lchown-functions">chown, fchown, fchownat, and lchown Functions</a></li>
        
    
        <li class="main "><a href="#file-size">File Size</a></li>
        
    
        <li class="main "><a href="#holes-in-a-file">Holes in a File</a></li>
        
    
        <li class="main "><a href="#file-truncation">File Truncation</a></li>
        
    
        <li class="main "><a href="#file-systems">File Systems</a></li>
        
    
        <li class="main "><a href="#link-linkat-unlink-unlinkat-and-remove-functions">link, linkat, unlink, unlinkat, and remove Functions</a></li>
        
    
        <li class="main "><a href="#rename-and-renameat-functions">rename and renameat Functions</a></li>
        
    
        <li class="main "><a href="#symbolic-links">Symbolic Links</a></li>
        
    
        <li class="main "><a href="#file-times">File Times</a></li>
        
    
        <li class="main "><a href="#futimens-utimensat-and-utimes-functions">futimens, utimensat, and utimes Functions</a></li>
        
    
        <li class="main "><a href="#mkdir-mkdirat-and-rmdir-functions">mkdir, mkdirat, and rmdir Functions</a></li>
        
    
        <li class="main "><a href="#reading-directories">Reading Directories</a></li>
        
    
        <li class="main "><a href="#chdir-fchdir-and-getcwd-functions">chdir, fchdir, and getcwd Functions</a></li>
        
            <li><a href="#device-special-files">Device Special Files</a></li>
        
    
        <li class="main "><a href="#doubts-and-solutions">Doubts and Solutions</a></li>
        
            <li><a href="#verbatim">Verbatim</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chapter-4-files-and-directories"><strong>Chapter 4. Files and Directories</strong></h3>
<p>This chapter centers on I/O for regular files.</p>
<h3 id="restrict-keyword"><code>restrict</code> keyword</h3>
<p>Added in C99, <a href="https://en.wikipedia.org/wiki/Restrict"><code>restrict</code></a> keyword is used to tell the compiler which pointer references can be optimized, by indicating that the object to which the pointer refers is accessed in the function only via that pointer. [p26]</p>
<h3 id="stat-fstat-fstatat-and-lstat-functions"><code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/dd0cdd90a54848ff3018">apue_stat.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">pathname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">buf</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fstat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">lstat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">pathname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">buf</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fstatat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">pathname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cm">/* All four return: 0 if OK, −1 on error */</span>
</pre></div>


<ul>
<li><code>stat</code>: returns a structure of information about the named file</li>
<li><code>fstat</code>: returns a structure of information about the given file descriptor</li>
<li><code>lstat</code>: similar to <code>stat</code>, returns information about the symbolic link, not the file referenced by the symbolic link</li>
<li><code>fstatat</code>:  return the file statistics for a pathname relative to an open directory represented by the fd argument; the flag argument controls whether symbolic links are followed</li>
</ul>
<p>The <code>buf</code> argument is a pointer to a <a href="http://en.wikipedia.org/wiki/Stat_(system_call)#stat_structure">structure</a> that we must supply. The functions fill in the structure.</p>
<div class="codehilite"><pre><span class="k">struct</span> <span class="n">stat</span> <span class="p">{</span>
    <span class="kt">mode_t</span>    <span class="n">st_mode</span><span class="p">;</span>
    <span class="kt">ino_t</span>    <span class="n">st_ino</span><span class="p">;</span>
    <span class="kt">dev_t</span>    <span class="n">st_dev</span><span class="p">;</span>
    <span class="kt">dev_t</span>    <span class="n">st_rdev</span><span class="p">;</span>
    <span class="n">nlink_t</span>    <span class="n">st_nlink</span><span class="p">;</span>
    <span class="kt">uid_t</span>    <span class="n">st_uid</span><span class="p">;</span>
    <span class="kt">gid_t</span>    <span class="n">st_gid</span><span class="p">;</span>
    <span class="kt">off_t</span>    <span class="n">st_size</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timespec</span>    <span class="n">st_atim</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timespec</span>    <span class="n">st_mtim</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timespec</span>    <span class="n">st_ctim</span><span class="p">;</span>
    <span class="n">blksize_t</span>    <span class="n">st_blksize</span><span class="p">;</span>
    <span class="n">blkcnt_t</span>    <span class="n">st_blocks</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<h4 id="timespec-structure"><code>timespec</code> structure</h4>
<p>The <code>timespec</code> structure type defines time in terms of seconds and nanoseconds. It includes at least the following fields:</p>
<div class="codehilite"><pre><span class="kt">time_t</span> <span class="n">tv_sec</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">tv_nsec</span><span class="p">;</span>
</pre></div>


<h3 id="file-types">File Types</h3>
<ul>
<li>Regular file. All binary executable files conform to a format that allows the kernel to identify where to load a program’s text and data.</li>
<li>Directory file. A file that contains the names of other files and pointers to information on these files. Any process that has read permission for a directory file can read the contents of the directory, but only the kernel can write directly to a directory file.</li>
<li>Block special file</li>
<li>Character special file</li>
<li>FIFO</li>
<li>Socket</li>
<li>Symbolic link</li>
</ul>
<p>This program prints the type of file for each command-line argument.</p>
<ul>
<li><a href="https://github.com/shichao-an/apue.3e/blob/master/filedir/filetype.c">filetype.c</a></li>
</ul>
<h3 id="set-user-id-and-set-group-id">Set-User-ID and Set-Group-ID</h3>
<p>Every process has six or more IDs associated with it:</p>
<ul>
<li>The <strong>real user ID</strong> and <strong>real group ID</strong>: who we really are.<ul>
<li>These two fields are taken from our entry in the password file when we log in.</li>
<li>Normally, these values don’t change during a login session, although there are ways for a superuser process to change them. (<a href="../ch8/#changing-user-ids-and-group-ids">Section 8.11</a>)</li>
</ul>
</li>
<li>The <strong>effective user ID</strong>, <strong>effective group ID</strong> and <strong>supplementary group IDs</strong>: used for file access permission checks.</li>
<li>The <strong>saved set-user-ID</strong> and <strong>saved set-group-ID</strong>: saved by <code>exec</code> functions. They contain copies of the effective user ID and the effective group ID, when a program is executed. (<a href="../ch8/#changing-user-ids-and-group-ids">Section 8.11</a>)</li>
</ul>
<p>Every file has an owner and a group owner:</p>
<ul>
<li>The owner is specified by the <code>st_uid</code> member of the <code>stat</code> structure;</li>
<li>The group owner is specified by the <code>st_gid</code> member of the <code>stat</code> structure.</li>
</ul>
<p>When we execute a program file, the effective user ID of the process is usually the real user ID, and the effective group ID is usually the real group ID. However, we can also set special flags in the file’s mode word (<code>st_mode</code>) that says:</p>
<ul>
<li>When this file is executed, set the effective user ID of the process to be the owner of the file (<code>st_uid</code>).</li>
<li>When this file is executed, set the effective group ID of the process to be the group owner of the file (<code>st_gid</code>).</li>
</ul>
<p>These two bits in the file’s mode word are called the <strong>set-user-ID</strong> (setuid) bit and the <strong>set-group-ID</strong> (setgid) bit.</p>
<p>For example:</p>
<ul>
<li>If the owner of the file is the superuser and if the file’s set-user-ID bit is set, then while that program file is running as a process, it has superuser privileges, regardless of the real user ID of the process that executes the file.</li>
<li><code>passwd(1)</code> is a set-user-ID program, so that the program can write the new password to the password file, typically either <code>/etc/passwd</code> or <code>/etc/shadow</code>, files that should be writable only by the superuser.</li>
</ul>
<p>Because a process that is running set-user-ID to some other user usually assumes extra permissions, it must be written carefully.</p>
<p>[p99]</p>
<h3 id="file-access-permissions">File Access Permissions</h3>
<ol>
<li>Whenever we want to open any type of file by name, we must have execute permission in each directory mentioned in the name, including the current directory, if it is implied. Read permission for a directory and execute permission for a directory mean different things. Read permission lets us read the directory, obtaining a list of all the filenames in the directory. Execute permission lets us pass through the directory when it is a component of a pathname that we are trying to access. [p100]</li>
<li>We cannot create a new file in a directory unless we have write permission and execute permission in the directory.</li>
</ol>
<h3 id="ownership-of-new-files-and-directories">Ownership of New Files and Directories</h3>
<ol>
<li>The user ID of a new file is set to the effective user ID of the process</li>
<li>The group ID of a new file can be the effective group ID of the process; or group ID of the directory in which the file is being created.</li>
</ol>
<p>FreeBSD 8.0 and Mac OS X 10.6.8 always copy the new file’s group ID from the directory.</p>
<h3 id="access-and-faccessat-functions"><code>access</code> and <code>faccessat</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/a0d8ab4d744d51be289f">apue_access.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">access</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">faccessat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p>These functions test accessibility based on the real user and group IDs.</p>
<p>The <code>flag</code> argument can be used to change the behavior of <code>faccessat</code>. If the <code>AT_EACCESS</code> flag is set, the access checks are made using the effective user and group IDs.</p>
<ul>
<li><a href="https://github.com/shichao-an/apue.3e/blob/master/filedir/access.c">access.c</a></li>
</ul>
<h3 id="umask-function"><code>umask</code> Function</h3>
<p>The Single UNIX Specification requires that the <code>umask</code> command support a symbolic mode of operation. Unlike the octal format, the symbolic format specifies which permissions are to be allowed instead of which ones are to be denied.</p>
<div class="codehilite"><pre>$ <span class="nb">umask</span>  <span class="c1"># first print the current file mode creation mask</span>
002
$ <span class="nb">umask</span> -S  <span class="c1"># print the symbolic form</span>
<span class="nv">u</span><span class="o">=</span>rwx,g<span class="o">=</span>rwx,o<span class="o">=</span>rx
$ <span class="nb">umask</span> <span class="m">027</span>  <span class="c1"># print the symbolic form</span>
$ <span class="nb">umask</span> -S  <span class="c1"># print the symbolic form</span>
<span class="nv">u</span><span class="o">=</span>rwx,g<span class="o">=</span>rx,o<span class="o">=</span>
</pre></div>


<h3 id="chmod-fchmod-and-fchmodat-functions"><code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/9fa2e6e7e6e600cb62c1">apue_chmod.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">chmod</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchmod</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchmodat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cm">/* All three return: 0 if OK, −1 on error */</span>
</pre></div>


<p><code>chmod</code> automatically clears the following permission bits under the following conditions:</p>
<ol>
<li>Setting sticky bit on a regular file without superuser privileges (Solaris)</li>
<li>If the group ID of the new file does not equal either the effective group ID of the process or one of the process’s supplementary group IDs and if the process does not have superuser privileges, then the set-group-ID bit is automatically turned off. On FreeBSD 8.0, Linux 3.2.0 and Mac OS X 10.6.8, if a process that does not have superuser privileges writes to a file, the set-user-ID and set-group-ID bits are automatically turned off.</li>
</ol>
<h3 id="sticky-bit">Sticky Bit</h3>
<p>Sticky Bit (<code>S_ISVTX</code>), or saved-text bit in the later versions of the UNIX System.</p>
<ul>
<li>On file: only on a minority of systems</li>
<li>On directory: <code>/tmp</code> and <code>/var/tmp</code></li>
</ul>
<h3 id="chown-fchown-fchownat-and-lchown-functions"><code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/233e97d9b3d15aca39b2">apue_chown.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">chown</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchown</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchownat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">lchown</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">uid_t</span> <span class="n">owner</span><span class="p">,</span> <span class="kt">gid_t</span> <span class="n">group</span><span class="p">);</span>

<span class="cm">/* All four return: 0 if OK, −1 on error */</span>
</pre></div>


<ul>
<li><code>lchown</code> and <code>fchownat</code> (with the <code>AT_SYMLINK_NOFOLLOW</code> flag set) change the owners of the symbolic link itself.</li>
<li><code>fchown</code> operates on a open file, it can’t be used to change the ownership of a symbolic link.</li>
</ul>
<p>Only the superuser can change the ownership of a file (FreeBSD 8.0, Linux 3.2.0, and Mac OS X 10.6.8)</p>
<p>When <code>_POSIX_CHOWN_RESTRICTED</code> is in effect, a non-superuser can’t change the user ID of your files; A nonsuperuser can change the group ID of files that he owns, but only to groups that he belongs to.</p>
<h3 id="file-size">File Size</h3>
<p>The <code>st_size</code> member of the stat structure contains the size of the file in bytes. This field is meaningful only for regular files, directories, and symbolic links.</p>
<p>FreeBSD 8.0, Mac OS X 10.6.8, and Solaris 10 also define the file size for a pipe as the number of bytes that are available for reading from the pipe.</p>
<ul>
<li>For a regular file, a file size of 0 is allowed. We’ll get an end-of-file indication on the first read of the file.</li>
<li>For a directory, the file size is usually a multiple of a number, such as 16 or 512.</li>
<li>For a symbolic link, the file size is the number of bytes in the filename.</li>
</ul>
<p>Most contemporary UNIX systems provide two fields:</p>
<ul>
<li><code>st_blksize</code>: preferred block size for I/O for the file</li>
<li><code>st_blocks</code>: actual number of 512-byte blocks that are allocated</li>
</ul>
<p>Be aware that different versions of the UNIX System use units other than 512-byte blocks for <code>st_blocks</code>. Use of this value is <strong>nonportable</strong>.</p>
<h3 id="holes-in-a-file">Holes in a File</h3>
<div class="codehilite"><pre>$ ls -l core
-rw-r--r-- <span class="m">1</span> sar <span class="m">8483248</span> Nov <span class="m">18</span> 12:18 core
$ du -s core
<span class="m">272</span> core
</pre></div>


<h3 id="file-truncation">File Truncation</h3>
<p><small><a href="https://gist.github.com/shichao-an/df5f6cc1cd7871670b11">apue_truncate.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">truncate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">length</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">ftruncate</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">length</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p>These two functions truncate an existing file to <em>length</em> bytes. If the previous size of the file was greater than <em>length</em>, the data beyond <em>length</em> is no longer accessible. Otherwise, if the previous size was less than <em>length</em>, the file size will increase and the data between the old end of file and the new end of file will read as 0 (a hole is probably created in the file).</p>
<h3 id="file-systems">File Systems</h3>
<p>Most UNIX file systems support <strong>case-sensitive</strong> filenames. On Mac OS X, however, the HFS file system is <strong>case-preserving</strong> with <strong>case-insensitive</strong> comparisons.</p>
<p><a href="../figure_4.14.png" title="Figure 4.14 Cylinder group’s i-nodes and data blocks in more detail"><img alt="Figure 4.14 Cylinder group’s i-nodes and data blocks in more detail" src="../figure_4.14_600.png" /></a></p>
<ul>
<li>Every i-node has a link count that contains the number of directory entries that point to it. Only when the link count (<code>st_nlink</code>) goes to 0 can the file be deleted.</li>
<li>With a symbolic link (file type <code>S_IFLNK</code>), the actual contents of the file (the data blocks) store the name of the file that the symbolic link points to.</li>
<li>The i-node contains all the information about the file: the file type, the file’s access permission bits, the size of the file, pointers to the file’s data blocks, and so on.</li>
<li>Only two items are stored in the directory entry: the filename and the i-node number. The data type for the i-node number is <code>ino_t</code>.</li>
</ul>
<h3 id="link-linkat-unlink-unlinkat-and-remove-functions"><code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/a05542802e846a5e4a9d">apue_link.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">link</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">existingpath</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newpath</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">linkat</span><span class="p">(</span><span class="kt">int</span> <span class="n">efd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">existingpath</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newpath</span><span class="p">,</span>
           <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p>When a file is closed, the kernel first checks the count of the number of processes that have the file open. If this count has reached 0, the kernel then checks the link count; if it is 0, the file’s contents are deleted.</p>
<p>When the <code>AT_REMOVEDIR</code> flag is set, then the <code>unlinkat</code> function can be used to remove a directory, similar to using <code>rmdir</code>.</p>
<p><small><a href="https://gist.github.com/shichao-an/6ed5d4f09ca321b9969d">apue_remove.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">remove</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>

<span class="cm">/* Returns: 0 if OK, −1 on error */</span>
</pre></div>


<h3 id="rename-and-renameat-functions"><code>rename</code> and <code>renameat</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/b2751a71cdecc9845951">apue_rename.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">rename</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oldname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newname</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">renameat</span><span class="p">(</span><span class="kt">int</span> <span class="n">oldfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oldname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newname</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<h3 id="symbolic-links">Symbolic Links</h3>
<p>It is possible to introduce loops into the file system by using symbolic links. Most functions that look up a pathname return an <code>errno</code> of <code>ELOOP</code> when this occurs.</p>
<p>On Linux, the <a href="http://linux.die.net/man/3/ftw"><code>ftw</code></a> and <code>nftw</code> functions record all directories seen and avoid processing a directory more than once, so they don’t display this behavior.</p>
<ul>
<li><code>ls -l</code></li>
<li><code>ls -F</code></li>
</ul>
<p><small><a href="https://gist.github.com/shichao-an/487e3a881014019a5896">apue_symlink.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">symlink</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">actualpath</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sympath</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">symlinkat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">actualpath</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sympath</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p>Because the open function follows a symbolic link, we need a way to open the link itself and read the name in the link.</p>
<p><small><a href="https://gist.github.com/shichao-an/8ee1ce45f97503e1eadf">apue_readlink.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">ssize_t</span> <span class="nf">readlink</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">pathname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">);</span>

<span class="kt">ssize_t</span> <span class="nf">readlinkat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">pathname</span><span class="p">,</span>
                   <span class="kt">char</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsize</span><span class="p">);</span>

<span class="cm">/* Both return: number of bytes read if OK, −1 on error */</span>
</pre></div>


<p>These functions combine the actions of <code>open</code>, <code>read</code>, and <code>close</code>.</p>
<h3 id="file-times">File Times</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Example</th>
<th>ls(1) option</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>st_atim</code></td>
<td>last-access time of file data</td>
<td><code>read</code></td>
<td><code>-u</code></td>
</tr>
<tr>
<td><code>st_mtim</code></td>
<td>last-modification time of file data</td>
<td><code>write</code></td>
<td>default</td>
</tr>
<tr>
<td><code>st_ctim</code></td>
<td>last-change time of i-node status</td>
<td><code>chmod</code>, <code>chown</code></td>
<td><code>-c</code></td>
</tr>
</tbody>
</table>
<p>The system does not maintain the last-access time for an i-node. The functions <code>access</code> and <code>stat</code> don’t change any of the three times.</p>
<h3 id="futimens-utimensat-and-utimes-functions"><code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/cbb255521bbfbd297ffe">apue_futimens.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">futimens</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="n">times</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="kt">int</span> <span class="nf">utimensat</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="n">times</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p>In both functions, the first element of the times array argument contains the <strong>access time</strong>, and the second element contains the <strong>modification time</strong>.</p>
<ul>
<li><a href="https://gist.github.com/shichao-an/45e1af258c8c65aef8e3">apue_utimes</a></li>
</ul>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">utimes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">times</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="cm">/* Returns: 0 if OK, −1 on error */</span>
</pre></div>


<p>We are unable to specify a value for the <strong>changed-status time</strong>, <code>st_ctim</code> (the time the i-node was last changed), as this field is automatically updated when the <code>utime</code> function is called.</p>
<h3 id="mkdir-mkdirat-and-rmdir-functions"><code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/72a28c9446973e80a80a.">apue_rmdir.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">rmdir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>

<span class="cm">/* Returns: 0 if OK, −1 on error */</span>
</pre></div>


<p>For a directory, we normally want at least one of the execute bits enabled, to allow access to filenames within the directory.</p>
<p>Solaris 10 and Linux 3.2.0 also have the new directory inherit the set-group-ID bit from the parent directory. Files created in the new directory will then inherit the group ID of that directory. With Linux, the file system implementation determines whether this behavior is supported. For example, the ext2, ext3, and ext4 file systems allow this behavior to be controlled by an option to the mount(1) command.</p>
<h3 id="reading-directories">Reading Directories</h3>
<p><small><a href="https://gist.github.com/shichao-an/e98f9a012d74b7a96293">apue_opendir.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp"></span>

<span class="kt">DIR</span> <span class="o">*</span><span class="nf">opendir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="kt">DIR</span> <span class="o">*</span><span class="nf">fdopendir</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
<span class="cm">/* Both return: pointer if OK, NULL on error */</span>

<span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="nf">readdir</span><span class="p">(</span><span class="kt">DIR</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
<span class="cm">/* Returns: pointer if OK, NULL at end of directory or error */</span>

<span class="kt">void</span> <span class="nf">rewinddir</span><span class="p">(</span><span class="kt">DIR</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">closedir</span><span class="p">(</span><span class="kt">DIR</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
<span class="cm">/* Returns: 0 if OK, −1 on error */</span>

<span class="kt">long</span> <span class="nf">telldir</span><span class="p">(</span><span class="kt">DIR</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
<span class="cm">/* Returns: current location in directory associated with dp */</span>

<span class="kt">void</span> <span class="nf">seekdir</span><span class="p">(</span><span class="kt">DIR</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="kt">long</span> <span class="n">loc</span><span class="p">);</span>
</pre></div>


<p>The <code>dirent</code> structure defined in <dirent.h> is implementation dependent, with at least the following two members:</p>
<div class="codehilite"><pre>    <span class="kt">ino_t</span>  <span class="n">d_ino</span><span class="p">;</span>                 <span class="cm">/* i-node number */</span>
    <span class="kt">char</span>   <span class="n">d_name</span><span class="p">[];</span>              <span class="cm">/* null-terminated filename */</span>
</pre></div>


<p>The <code>DIR</code> structure is an internal structure used by these seven functions to maintain information about the directory being read. The purpose of the DIR structure is similar to that of the <code>FILE</code> structure maintained by the standard I/O library,</p>
<ul>
<li><a href="https://github.com/shichao-an/apue.3e/blob/master/filedir/ftw8.c">ftw8.c</a></li>
</ul>
<h3 id="chdir-fchdir-and-getcwd-functions"><code>chdir</code>, <code>fchdir</code>, and <code>getcwd</code> Functions</h3>
<p><small><a href="https://gist.github.com/shichao-an/fb972392bdd5ce97dc7e">apue_chdir.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">chdir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchdir</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>

<span class="cm">/* Both return: 0 if OK, −1 on error */</span>
</pre></div>


<p><small><a href="https://gist.github.com/shichao-an/090c8c9281d8da18bed5">apue_getcwd.h</a></small></p>
<div class="codehilite"><pre><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">getcwd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

<span class="cm">/* Returns: buf if OK, NULL on error */</span>
</pre></div>


<h4 id="device-special-files">Device Special Files</h4>
<ul>
<li>Every file system is known by its <strong>major</strong> and <strong>minor</strong> device numbers, which are encoded in the primitive system data type <code>dev_t</code>.</li>
<li>We can usually access the major and minor device numbers through two macros defined by most implementations: <code>major</code> and <code>minor</code>.</li>
</ul>
<p>On Linux 3.2.0, <code>dev_t</code> is a 64-bit integer, only 12 bits are used for the major number and 20 bits are used for the minor number. Linux defines these macros in <code>&lt;sys/sysmacros.h&gt;</code>, which is included by <code>&lt;sys/types.h&gt;</code>.</p>
<p>The <code>st_dev</code> value for every filename on a system is the device number of the file system containing that filename and its corresponding i-node.</p>
<p>Only character special files and block special files have an <code>st_rdev</code> value. This value contains the device number for the actual device.</p>
<hr />
<h3 id="doubts-and-solutions">Doubts and Solutions</h3>
<h4 id="verbatim">Verbatim</h4>
<p>Section 4.21 on <code>rmdir</code> [p130]:</p>
<blockquote>
<p>If the link count of the directory becomes 0 with this call, and if no other process has the directory open, then the space occupied by the directory is freed. If one or more processes have the directory open when the link count reaches 0, the last link is removed and the dot and dot-dot entries are removed before this function returns. Additionally, no new files can be created in the directory.</p>
</blockquote>
<p>Does "link count" here mean number of entries (except dot and dot-dot)? Otherwise, this contradicts  "any leaf directory (a directory that does not contain any other directories) always has a link count of 2" in section 4.14 on page 115.</p>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>