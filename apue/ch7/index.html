<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/apue/ch7/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Chapter 7. Process Environment - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                    
                        <li >
                            <a href="../ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                    
                        <li >
                            <a href="../ch3/">Chapter 3. File I/O</a>
                        </li>
                    
                        <li >
                            <a href="../ch4/">Chapter 4. Files and Directories</a>
                        </li>
                    
                        <li >
                            <a href="../ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                    
                        <li >
                            <a href="../ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Chapter 7. Process Environment</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UTLK <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../utlk/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../utlk/ch2/">Chapter 2. Memory Addressing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">ICND <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../icnd1/part1/">ICND1 Part I: Networking Fundamentals</a>
                        </li>
                    
                        <li >
                            <a href="../../icnd2/part1/">ICND2 Part I: LAN Switching</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../htae/">HTAE</a>
                        </li>
                    
                        <li >
                            <a href="../../golang/">Go</a>
                        </li>
                    
                        <li >
                            <a href="../../bash/">Bash</a>
                        </li>
                    
                        <li >
                            <a href="../../c/">C</a>
                        </li>
                    
                        <li >
                            <a href="../../iptables/">iptables</a>
                        </li>
                    
                        <li >
                            <a href="../../nginx/">Nginx</a>
                        </li>
                    
                        <li >
                            <a href="../../vim/">Vim</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../ch6/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../utlk/ch1/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/shichao-an/notes">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-7-process-environment">Chapter 7. Process Environment</a></li>
        
    
        <li class="main "><a href="#introduction">Introduction</a></li>
        
    
        <li class="main "><a href="#main-function">main Function</a></li>
        
    
        <li class="main "><a href="#process-termination">Process Termination</a></li>
        
            <li><a href="#atexit-function">atexit Function</a></li>
        
    
        <li class="main "><a href="#command-line-arguments">Command-Line Arguments</a></li>
        
    
        <li class="main "><a href="#environment-list">Environment List</a></li>
        
    
        <li class="main "><a href="#memory-layout-of-a-c-program">Memory Layout of a C Program</a></li>
        
    
        <li class="main "><a href="#shared-libraries">Shared Libraries</a></li>
        
    
        <li class="main "><a href="#memory-allocation">Memory Allocation</a></li>
        
            <li><a href="#alternate-memory-allocators">Alternate Memory Allocators</a></li>
        
    
        <li class="main "><a href="#environment-variables">Environment Variables</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h3 id="chapter-7-process-environment"><strong>Chapter 7. Process Environment</strong></h3>
<h3 id="introduction">Introduction</h3>
<h3 id="main-function"><code>main</code> Function</h3>
<p>A C program starts execution with a function called <code>main</code>:</p>
<pre><code class="c">int main(int argc, char *argv[]);
</code></pre>

<ul>
<li><em>argc</em>: number of command-line arguments</li>
<li><em>argv</em>: an array of pointers to the arguments</li>
</ul>
<p>When a C program is executed by the kernel (by one of the <code>exec</code> functions), a special start-up routine is called before the <code>main</code> function is called. The executable program file specifies this routine as the starting address for the program; this is set up by the link editor (linker) when it is invoked by the C compiler. This start-up routine takes values from the kernel (the command-line arguments and the environment) and sets things up so that the <code>main</code> function is called as shown earlier.</p>
<h3 id="process-termination">Process Termination</h3>
<p>Three functions terminate a program normally:</p>
<script src="https://gist.github.com/shichao-an/8387fdff1497e1cc7fd6.js"></script>

<ul>
<li><code>_exit</code>: returns to the kernel immediately</li>
<li><code>_Exit</code>: same as <code>_exit</code></li>
<li><code>exit</code>: performs certain cleanup processing and then returns to the kernel. Historically, it has always performed a clean shutdown of the standard I/O library: the <code>fclose</code> function is called for all open streams</li>
</ul>
<p>All three exit functions expect a single integer argument (<strong>exit status</strong>).</p>
<p>The <u>exit status of the process is undefined</u>, if any of the following occurs:</p>
<ul>
<li>Any of these functions is called without an exit status</li>
<li><code>main</code> does a return without a return value</li>
<li><code>main</code> function is not declared to return an integer</li>
</ul>
<p>If the return type of main is an integer and main "falls off the end" (an implicit return), the exit status of the process is 0.</p>
<p>Returning an integer value from the main function is equivalent to calling exit with the same value:</p>
<p><code>exit(0);</code> is same as <code>return(0);</code> from the <code>main</code> function.</p>
<h4 id="atexit-function"><code>atexit</code> Function</h4>
<p>With ISO C, a process can register at least 32 functions that are automatically called by <code>exit</code>. These are called <strong>exit handlers</strong> and are registered by calling the <code>atexit</code> function.</p>
<script src="https://gist.github.com/shichao-an/edfab5a8a91b62b4ba5b.js"></script>

<ul>
<li><em>func</em> argument is the address of the function to be called by <code>exit</code>. When this function is called, it is not passed any arguments and is not expected to return a value. The <code>exit</code> function calls these functions in reverse order of their registration. Each function is called as many times as it was registered.</li>
</ul>
<p>With ISO C and POSIX.1, <code>exit</code> first calls the exit handlers and then closes (via <code>fclose</code>) all open streams. POSIX.1 extends the ISO C standard by specifying that any exit handlers installed will be cleared if the program calls any of the <code>exec</code> family of functions.</p>
<p>The only way a program can be executed by the kernel is if one of the <code>exec</code> functions is called. <u>The only way a process can voluntarily terminate is if <code>_exit</code> or <code>_Exit</code> is called</u>, either explicitly or implicitly (by calling <code>exit</code>). A process can also be involuntarily terminated by a signal.</p>
<h3 id="command-line-arguments">Command-Line Arguments</h3>
<p>When a program is executed, the process that does the <code>exec</code> can pass command-line arguments to the new program. This is part of the normal operation of the UNIX system shells.</p>
<p>Example:</p>
<pre><code class="c">#include &quot;apue.h&quot;

int
main(int argc, char *argv[])
{
    int i;
    for (i = 0; i &lt; argc; i++) /* echo all command-line args */
        printf(&quot;argv[%d]: %s\n&quot;, i, argv[i]);
    exit(0);
}
</code></pre>

<p>We are guaranteed by both ISO C and POSIX.1 that argv[argc] is a null pointer. This lets us alternatively code the argument-processing loop as:</p>
<pre><code class="c">for (i = 0; argv[i] != NULL; i++)
</code></pre>

<h3 id="environment-list">Environment List</h3>
<p>Each program is also passed an environment list, which is an array of character pointers, with each pointer containing the address of a null-terminated C string. It is contained in the global variable environ:</p>
<pre><code class="c">extern char **environ;
</code></pre>

<p><a href="../figure_7.5.png" title="Figure 7.5 Environment consisting of five C character strings"><img alt="Figure 7.5 Environment consisting of five C character strings" src="../figure_7.5_600.png" /></a></p>
<ul>
<li><code>environ</code> is called the <strong>environment pointer</strong>, the array of pointers the environment list, and the strings they point to the <strong>environment strings</strong>, which by convention is <code>name=value</code> strings. By convetion, predefined names are entirely uppercase.</li>
</ul>
<h3 id="memory-layout-of-a-c-program">Memory Layout of a C Program</h3>
<p>Historically, a C program has been composed of the following pieces:</p>
<ul>
<li>Text segment: consists of the machine instructions that the CPU executes</li>
<li>Initialized data segment (or simply data segment): contains variables that are specifically initialized in the program</li>
<li>Uninitialized data segment (often called the "bss" segment, which is named after "block started by symbol"): data in this segment is initialized by the kernel to arithmetic 0 or null pointers before the program starts executing</li>
<li>Stack: stores automatic variables, along with information that is saved each time a function is called</li>
<li>Heap is where dynamic memory allocation usually takes place</li>
</ul>
<p><a href="../figure_7.6.png" title="Figure 7.5 Environment consisting of five C character strings"><img alt="Figure 7.5 Environment consisting of five C character strings" src="../figure_7.6.png" /></a></p>
<p>With Linux on a 32-bit Intel x86 processor, the text segment starts at location <code>0x08048000</code>, and the bottom of the stack starts just below <code>0xC0000000</code>. <u>The stack grows from higher-numbered addresses to lower-numbered addresses on this particular architecture.</u> The unused virtual address space between the top of the heap and the top of the stack is large</p>
<p>The <code>size(1)</code> command reports the sizes (in bytes) of the text, data, and bss segments:</p>
<pre><code class="text">    $ size /usr/bin/cc /bin/sh
    text data bss dec hex filename
    346919 3576 6680 357175 57337 /usr/bin/cc
    102134 1776 11272 115182 1c1ee /bin/sh
</code></pre>

<h3 id="shared-libraries">Shared Libraries</h3>
<p>Shared libraries remove the common library routines from the executable file and maintains a single copy of the library routine somewhere in memory that all processes reference:</p>
<ul>
<li>Pros: reduces the size of each executable file; library functions can be replaced with new versions without having to relink edit every program that uses the library</li>
<li>Cons: adds some runtime overhead, either when the program is first executed or the first time each shared library function is called</li>
</ul>
<h3 id="memory-allocation">Memory Allocation</h3>
<script src="https://gist.github.com/shichao-an/e4b320547e3c303af467.js"></script>

<ul>
<li><code>malloc</code>: allocates a specified number of bytes of memory</li>
<li><code>calloc</code>: allocates space for a specified number of objects of a specified size</li>
<li><code>realloc</code>: increases or decreases the size of a previously allocated area. The final argument to realloc is the new size of the region, not the
difference between the old and new sizes</li>
</ul>
<p>The pointer returned by the three allocation functions is guaranteed to be suitably aligned so that it can be used for any data object.</p>
<p>Because the three <code>alloc</code> functions return a generic <code>void *</code> pointer, if we <code>#include &lt;stdlib.h&gt;</code> (to obtain the function prototypes), we do not explicitly have to cast the pointer returned by these functions when we assign it to a pointer of a different type. <u>The default return value for undeclared functions is int, so using a cast without the proper function declaration could hide an error on systems where the size of type int differs from the size of a functionâ€™s return value (a pointer in this case).</u></p>
<ul>
<li><code>free</code>: causes the space pointed to by <em>ptr</em> to be deallocated. This freed space is usually put into a pool of available memory and can be allocated in a later call to one of the three <code>alloc</code> functions.</li>
</ul>
<p>The allocation routines are usually implemented with the <code>sbrk(2)</code> system call. This system call expands (or contracts) the heap of the process. Although <code>sbrk</code> can expand or contract the memory of a process, most versions of <code>malloc</code> and free never decrease their memory size. <u>The space that we free is available for a later allocation, but the freed space is not usually returned to the kernel; instead, that space is kept in the <code>malloc</code> pool.</u></p>
<h4 id="alternate-memory-allocators">Alternate Memory Allocators</h4>
<p>[p209]</p>
<ul>
<li><code>libmalloc</code></li>
<li><code>vmalloc</code></li>
<li><code>quick-fit</code></li>
<li><code>jemalloc</code></li>
<li><code>TCMalloc</code></li>
<li><code>alloca</code> Function: has the same calling sequence as <code>malloc</code>; however, instead of allocating memory from the heap, the memory is allocated from the stack frame of the current function</li>
</ul>
<h3 id="environment-variables">Environment Variables</h3>
<p>The environment strings are usually of the form:</p>
<pre><code>name=value
</code></pre>

<p>The UNIX kernel never looks at these strings; their interpretation is up to the various applications. </p>
<script src="https://gist.github.com/shichao-an/618104c2fa3a6caba3b3.js"></script>

<ul>
<li><code>getenv</code>: returns a pointer to the value of a <code>name=value</code> string. We should always use <code>getenv</code> to fetch a specific value from the environment, instead of accessing <code>environ</code> directly</li>
</ul>
<p><a href="../figure_7.7.png" title="Figure 7.7 Environment variables defined in the Single UNIX Specification"><img alt="Figure 7.7 Environment variables defined in the Single UNIX Specification" src="../figure_7.7_600.png" /></a></p>
<ul>
<li><code>putenv</code>: takes a string of the form <code>name=value</code> and places it in the environment list. If name already exists, its old definition is first removed.</li>
<li><code>setenv</code>: sets <em>name</em> to <em>value</em>. If name already exists in the environment, then:<ul>
<li>If <em>rewrite</em> is nonzero, the existing definition for <em>name</em> is first removed</li>
<li>If <em>rewrite</em> is 0, the existing definition for <em>name</em> is not removed, <em>name</em> is not set to the new value, and no error occurs</li>
</ul>
</li>
<li><code>unsetenv</code>: removes any definition of name. It is not an error if such a definition does not exist.</li>
</ul>
<p>Note the difference between <code>putenv</code> and <code>setenv</code>. Whereas <code>setenv</code> must allocate memory to create the <code>name=value</code> string from its arguments, <code>putenv</code> is free to place the string passed to it directly into the environment. Indeed, many implementations do exactly this, so <u>it would be an error to pass putenv a string allocated on the stack, since the memory would be reused after we return from the current function.</u></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>