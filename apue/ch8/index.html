<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/apue/ch8/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Chapter 8. Process Control - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                    
                        <li >
                            <a href="../ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                    
                        <li >
                            <a href="../ch3/">Chapter 3. File I/O</a>
                        </li>
                    
                        <li >
                            <a href="../ch4/">Chapter 4. Files and Directories</a>
                        </li>
                    
                        <li >
                            <a href="../ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                    
                        <li >
                            <a href="../ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                    
                        <li >
                            <a href="../ch7/">Chapter 7. Process Environment</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Chapter 8. Process Control</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UTLK <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../utlk/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../utlk/ch2/">Chapter 2. Memory Addressing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">ICND <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../icnd1/part1/">ICND1 Part I: Networking Fundamentals</a>
                        </li>
                    
                        <li >
                            <a href="../../icnd2/part1/">ICND2 Part I: LAN Switching</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../tcpv1/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                    
                        <li >
                            <a href="../../tcpv1/headers/">Headers</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../htae/">HTAE</a>
                        </li>
                    
                        <li >
                            <a href="../../golang/">Go</a>
                        </li>
                    
                        <li >
                            <a href="../../bash/">Bash</a>
                        </li>
                    
                        <li >
                            <a href="../../c/">C</a>
                        </li>
                    
                        <li >
                            <a href="../../iptables/">iptables</a>
                        </li>
                    
                        <li >
                            <a href="../../nginx/">Nginx</a>
                        </li>
                    
                        <li >
                            <a href="../../vim/">Vim</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="https://github.com/shichao-an/notes">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-8-process-control">Chapter 8. Process Control</a></li>
        
    
        <li class="main "><a href="#process-identifiers">Process Identifiers</a></li>
        
    
        <li class="main "><a href="#fork-function">fork Function</a></li>
        
            <li><a href="#file-sharing">File Sharing</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h3 id="chapter-8-process-control"><strong>Chapter 8. Process Control</strong></h3>
<h3 id="process-identifiers">Process Identifiers</h3>
<p>Every process has a unique process ID, a non-negative integer. As processes terminate, their IDs can be reused. <u>Most UNIX systems implement algorithms to delay reuse so that newly created processes are assigned IDs different from those used by processes that terminated recently. This prevents a new process from being mistaken for the previous process to have used the same ID.</u></p>
<p>There are some special processes, but the details differ from implementation to implementation:</p>
<ul>
<li>Process ID 0: scheduler process (often known as the <strong>swapper</strong>), which is part of the kernel and is known as a system process</li>
<li>Process ID 1: <code>init</code> process, invoked by the kernel at the end of the bootstrap procedure.<ul>
<li>It is responsible for bringing up a UNIX system after the kernel has been bootstrapped. <code>init</code> usually reads the system-dependent initialization files (<code>/etc/rc*</code> files or <code>/etc/inittab</code> and the files in <code>/etc/init.d</code>) and brings the system to a certain state.</li>
<li>It never dies.</li>
<li>It is a normal user process, not a system process within the kernel.</li>
<li>It runs with superuser privileges.</li>
</ul>
</li>
</ul>
<p><u>Each UNIX System implementation has its own set of kernel processes that provide operating system services.</u> For example, on some virtual memory implementations of the UNIX System, process ID 2 is the <em>pagedaemon</em>. This process is responsible for supporting the paging of the virtual memory system.</p>
<script src="https://gist.github.com/shichao-an/4afacfab973219fb4721.js"></script>

<p>None of these functions has an error return.</p>
<h3 id="fork-function"><code>fork</code> Function</h3>
<p>An existing process can create a new one by calling the <code>fork</code> function.</p>
<script src="https://gist.github.com/shichao-an/1d1bfd83197d3c929164.js"></script>

<ul>
<li>The new process created by <code>fork</code> is called the <strong>child process</strong>. This function is called once but returns twice. The only difference in the returns is that the return value in the child is 0, whereas the return value in the parent is the process ID of the new child. [p299]<ul>
<li><code>fork</code> returns child's process ID in parent: a process can have more than one child, and <u>there is no function that allows a process to obtain the process IDs of its children</u></li>
<li><code>fork</code> returns 0 in child: <u>a process can have only a single parent, and the child can always call <code>getppid</code> to obtain the process ID of its parent</u></li>
</ul>
</li>
<li>Both the child and the parent continue executing with the instruction that follows the call to <code>fork</code>. The child is a copy of the parent; the parent and the child do not share these portions of memory. The parent and the child do share the text segment.</li>
<li>Copy-on-write (COW) is used on modern implementations: a complete copy of the parent’s data, stack and heap is not performed. The shared regions are changed to read-only by the kernel. The kernel makes a copy of that piece of memory only if either process tries to modify these regions.</li>
</ul>
<p>Variations of the <code>fork</code> function are provided by some platforms. All four platforms discussed in this book support the <code>vfork(2)</code> variant discussed in the next section. Linux 3.2.0 also provides new process creation through the <code>clone(2)</code> system call. This is a generalized form of <code>fork</code> that allows the caller to control what is shared between parent and child.</p>
<p>Example (<a href="https://github.com/shichao-an/apue.3e/blob/master/proc/fork1.c">fork1.c</a>):</p>
<pre><code class="c">#include &quot;apue.h&quot;

int globvar = 6; /* external variable in initialized data */
char buf[] = &quot;a write to stdout\n&quot;;

int
main(void)
{
    int var; /* automatic variable on the stack */
    pid_t pid;

    var = 88;
    if (write(STDOUT_FILENO, buf, sizeof(buf)-1) != sizeof(buf)-1)
        err_sys(&quot;write error&quot;);
    printf(&quot;before fork\n&quot;); /* we don’t flush stdout */

    if ((pid = fork()) &lt; 0) {
        err_sys(&quot;fork error&quot;);
    } else if (pid == 0) { /* child */
        globvar++; /* modify variables */
        var++;
    } else {
        sleep(2); /* parent */
    }

    printf(&quot;pid = %ld, glob = %d, var = %d\n&quot;, (long)getpid(), globvar,
           var);
    exit(0);
}
</code></pre>

<pre><code class="text">$ ./a.out
a write to stdout
before fork
pid = 430, glob = 7, var = 89 # child’s variables were changed
pid = 429, glob = 6, var = 88 # parent’s copy was not changed
$ ./a.out &gt; temp.out
$ cat temp.out
a write to stdout
before fork
pid = 432, glob = 7, var = 89
before fork
pid = 431, glob = 6, var = 88
</code></pre>

<p>Analysis:</p>
<ul>
<li>Whether the child starts executing before the parent or vice versa is not known. The order depends on the scheduling algorithm used by the kernel. If it’s required that the child and parent synchronize their actions, some form of interprocess communication is required.</li>
<li><code>sizeof(buf)-1</code> (subtracting 1 from the size of <code>buf</code>) avoids writing the terminating null byte. <code>strlen</code> calculates the length of a string not including the terminating null byte, while <code>sizeof</code> calculates the size of the buffer, including the terminating null byte. However, using <code>strlen</code> requires a function call, whereas <code>sizeof</code> calculates the buffer length at compile time.</li>
<li>"a write to stdout" (once): <code>write</code> function is not buffered and is called before the <code>fork</code>, its data is written once to standard output</li>
<li>"before fork" (once in the first case, twice in the second case): <u><code>printf</code> from the standard I/O library is buffered</u><ul>
<li>First case (running the program interactively): standard I/O is <u>line buffered</u> and standard output buffer is flushed by the newline</li>
<li>Second case (redirect stdout to a file): standard I/O is <u>fully buffered</u>. The <code>printf</code> (<code>printf("before fork\n");</code>) before the <code>fork</code> is called once, but the line remains in the buffer when <code>fork</code> is called. <u>This buffer is then copied into the child when the parent’s data space is copied to the child. Both the parent and the child now have a standard I/O buffer with this line in it.</u> The second <code>printf</code> (<code>printf("pid = %ld, glob = %d, var = %d\n", ...);</code>), right before the exit, just appends its data to the existing buffer. When each process terminates, its copy of the buffer is finally flushed.</li>
</ul>
</li>
</ul>
<h4 id="file-sharing">File Sharing</h4></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>