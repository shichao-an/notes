<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/utlk/ch2/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Chapter 2. Memory Addressing - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UTLK <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Chapter 2. Memory Addressing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../golang/">Golang</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../bash/">Bash</a>
                        </li>
                    
                        <li >
                            <a href="../../c/">C</a>
                        </li>
                    
                        <li >
                            <a href="../../nginx/">Nginx</a>
                        </li>
                    
                        <li >
                            <a href="../../iptables/">iptables</a>
                        </li>
                    
                        <li >
                            <a href="../../vim/">Vim</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../ch1/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../unp/ch1/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/shichao-an/notes">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-2-memory-addressing">Chapter 2. Memory Addressing</a></li>
        
            <li><a href="#memory-addresses">Memory Addresses</a></li>
        
            <li><a href="#segmentation-in-hardware">Segmentation in Hardware</a></li>
        
            <li><a href="#segment-selectors">Segment Selectors</a></li>
        
            <li><a href="#segmentation-registers">Segmentation registers</a></li>
        
            <li><a href="#segment-descriptors">Segment Descriptors</a></li>
        
            <li><a href="#fast-access-to-segment-descriptors">Fast Access to Segment Descriptors</a></li>
        
            <li><a href="#segmentation-unit">Segmentation Unit</a></li>
        
            <li><a href="#segmentation-in-linux">Segmentation in Linux</a></li>
        
            <li><a href="#doubts-and-solutions">Doubts and Solutions</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h2 id="chapter-2-memory-addressing">Chapter 2. Memory Addressing</h2>
<p>This chapter offers details in <a href="http://en.wikipedia.org/wiki/X86">x86</a> microprocessors address memory chips and how Linux uses the available addressing circuits.</p>
<h3 id="memory-addresses">Memory Addresses</h3>
<ul>
<li><strong>Logical address</strong></li>
<li><strong>Linear address</strong> (also known as <strong>virtual address</strong>)</li>
<li><strong>Physical address</strong></li>
</ul>
<p>Memory Management Unit (MMU) transforms a logical address into a linear address, and the linear address into a physical address.</p>
<p><a href="../figure_2-1.png" title="Figure 2-1. Logical address translation"><img alt="Figure 2-1. Logical address translation" src="../figure_2-1_600.png" /></a></p>
<p>Memory arbiter: read or write operations on a RAM chip must be performed serially.</p>
<h3 id="segmentation-in-hardware">Segmentation in Hardware</h3>
<p>The following sections focus on address translation when <strong>protected mode</strong> is enabled, in Intel microprocessors starting with the 80286 model.</p>
<h3 id="segment-selectors">Segment Selectors</h3>
<p>A logical address consists of:</p>
<ul>
<li><strong>Segment Selector</strong> (segment identifier): 16-bit</li>
<li>Offset: 32-bit</li>
</ul>
<h3 id="segmentation-registers">Segmentation registers</h3>
<p><strong>Segmentation Registers</strong> hold Segment Selectors.</p>
<ul>
<li><code>cs</code>: code segment (program instructions); 2-bit field for CPU's Current Privilege Level (CPL), Linux uses only levels 0 and 3 for Kernel Mode and User Mode</li>
<li><code>ss</code>: stack segment (current program stack)</li>
<li><code>ds</code>: data segment (global and static data)</li>
<li><code>es</code>, <code>fs</code>, and <code>gs</code>: general purpose (arbitrary data)</li>
</ul>
<h3 id="segment-descriptors">Segment Descriptors</h3>
<p>Each segment is represented by an 8-byte <strong>Segment Descriptor</strong> that describes the segment characteristics. Segment Descriptors are stored either in the <strong>Global Descriptor Table</strong> (GDT) or in the <strong>Local Descriptor Table</strong> (LDT). The address and size of GDT and LDT are contained in <code>gdtr</code> and <code>ldtr</code> control registers respectively.</p>
<ul>
<li>Code Segment Descriptor: included in GDT or LDT</li>
<li>Data Segment Descriptor: included in GDT or LDT</li>
<li>Task State Segment Descriptor (TSSD): refers to a Task State Segment (TSS), a segment used to save the contents of the processor registers; included in GDT only</li>
<li>Local Descriptor Table Descriptor (LDTD): refers to a segment containing an LDT; included in GDT only</li>
</ul>
<h3 id="fast-access-to-segment-descriptors">Fast Access to Segment Descriptors</h3>
<p>Segmentation registers store only the Segment Selector. The x86 process provides an additional nonprogrammable register for each of the six programmable segmentation registers to speed up the translation of logical addresses into linear addresses. Each nonprogrammable register contains the 8-byte Segment Descriptor.</p>
<p>Segment Selector fields [p40]:</p>
<ul>
<li><code>index</code>: identifies the Segment Descriptor entry contained in GDT or LDT</li>
<li><code>TI</code> (Table Indicator): specifies whether the Segment Descriptor is included in the GDT (<code>TI</code> = 0) or in the LDT (<code>TI</code> = 1).</li>
<li><code>RPL</code> (Requestor Privilege Level):  specifies the Current Privilege Level (CPL) of the CPU when the corresponding Segment Selector is loaded into the <code>cs</code> register</li>
</ul>
<h3 id="segmentation-unit">Segmentation Unit</h3>
<p>The <strong>segmentation unit</strong> performs the following operations to obtain the linear address:</p>
<p><a href="../figure_2-5.png" title="Figure 2-5. Translating a logical address"><img alt="Figure 2-5. Translating a logical address" src="../figure_2-5.png" /></a></p>
<ul>
<li>Examines the <code>TI</code> field of the Segment Selector to determine which Descriptor Table (GDT or LDT) stores the Segment Descriptor</li>
<li>Computes the address of the Segment Descriptor from the <code>index</code> field of the Segment Selector</li>
<li>Adds the offset of the logical address to the <code>Base</code> field of the Segment Descriptor</li>
</ul>
<h3 id="segmentation-in-linux">Segmentation in Linux</h3>
<p>All Linux processes running in User Mode use the same pair of segments to address instructions and data. This is similar to processes running in Kernel Mode.</p>
<ul>
<li>user code segment</li>
<li>user data segment</li>
<li>kernel code segment</li>
<li>kernel data segment</li>
</ul>
<p>Segment Selectors are defined by the macros:</p>
<ul>
<li><code>__USER_CS</code></li>
<li><code>__USER_DS</code></li>
<li><code>__KERNEL_CS</code></li>
<li><code>__KERNEL_DS</code></li>
</ul>
<p>To address the kernel code segment, for instance, the kernel just loads the value yielded by the <code>__KERNEL_CS</code> macro into the <code>cs</code> segmentation register.</p>
<p>The linear addresses associated with such segments all start at 0 and reach the addressing limit of 2<sup>32</sup> â€“1. This means that all processes, either in User Mode or in Kernel Mode, may use the same logical addresses.</p>
<h4 id="cpl-rpl-and-registers"><a href="http://en.wikipedia.org/wiki/Protection_ring">CPL</a>, <code>RPL</code> and registers</h4>
<p>The Current Privilege Level (CPL) of the CPU indicates whether the processor is in User or Kernel Mode and is specified by the <code>RPL</code> field of the Segment Selector stored in the <code>cs</code> register. [p42]</p>
<p>Whenever the CPL is changed, some segmentation registers (e.g. <code>ds</code>, <code>ss</code>) must be correspondingly updated. [p42-43]</p>
<h4 id="implicit-segment-selector">Implicit Segment Selector</h4>
<p>Only Offset component of its logical address is specified:</p>
<ul>
<li><code>ss</code>: kernel saves a pointer to an instruction or to a data structure</li>
<li><code>cs</code>: kernel invokes a function</li>
<li><code>ds</code>: kernel data structure</li>
<li><code>es</code>: user data structure</li>
</ul>
<hr />
<h3 id="doubts-and-solutions">Doubts and Solutions</h3>
<p>Segmentation in Linux [p41]</p>
<blockquote>
<p>However, Linux uses segmentation in a very limited way. In fact, segmentation and paging are somewhat redundant, because both can be used to separate the physical address spaces of processes: segmentation can assign a different linear address space to each process, while paging can map the same linear address space into different physical address spaces. Linux prefers paging to segmentation for the following reasons:</p>
</blockquote></div>
        </div>

        

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>